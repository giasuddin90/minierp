{% extends 'base.html' %}

{% block title %}{% if object %}Edit{% else %}New{% endif %} Purchase Order - Building Materials ERP{% endblock %}

{% block page_title %}{% if object %}Edit Purchase Order{% else %}New Purchase Order{% endif %}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-cart-plus"></i>
                    {% if object %}Edit Purchase Order{% else %}New Purchase Order{% endif %}
                </h5>
            </div>
            <div class="card-body">
                <!-- Required Fields Notice -->
                <div class="alert alert-info mb-4">
                    <h6><i class="bi bi-info-circle"></i> Required Fields</h6>
                    <p class="mb-0">Fields marked with <span class="text-danger fw-bold">*</span> are required and must be filled before submitting the form.</p>
                </div>
                
                <form method="post">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="id_supplier" class="form-label">
                                <i class="bi bi-building"></i> Supplier <span class="text-danger fw-bold">*</span>
                            </label>
                            <select class="form-select" id="id_supplier" name="supplier" required>
                                <option value="">Select Supplier</option>
                                {% for supplier in suppliers %}
                                <option value="{{ supplier.id }}" {% if object.supplier.id == supplier.id %}selected{% endif %}>
                                    {{ supplier.name }} {% if supplier.company_name %}({{ supplier.company_name }}){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">Please select a supplier.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="id_order_date" class="form-label">
                                <i class="bi bi-calendar"></i> Order Date <span class="text-danger fw-bold">*</span>
                            </label>
                            <input type="date" class="form-control" id="id_order_date" name="order_date" value="{{ object.order_date|date:'Y-m-d'|default:'' }}" required>
                            <div class="invalid-feedback">Please select an order date.</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="id_expected_delivery_date" class="form-label">
                                <i class="bi bi-calendar-check"></i> Expected Delivery Date <span class="text-danger fw-bold">*</span>
                            </label>
                            <input type="date" class="form-control" id="id_expected_date" name="expected_date" value="{{ object.expected_date|date:'Y-m-d'|default:'' }}" required>
                            <div class="invalid-feedback">Please select an expected delivery date.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="id_status" class="form-label">Status</label>
                            <select class="form-select" id="id_status" name="status">
                                <option value="pending" {% if object.status == 'pending' %}selected{% endif %}>Pending</option>
                                <option value="confirmed" {% if object.status == 'confirmed' %}selected{% endif %}>Confirmed</option>
                                <option value="received" {% if object.status == 'received' %}selected{% endif %}>Received</option>
                                <option value="cancelled" {% if object.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Products Selection Section -->
                    <div class="mb-4">
                        <h6 class="mb-3">
                            <i class="bi bi-box-seam"></i>
                            Products
                        </h6>
                        <div id="products-container">
                            {% if object and object.items.all %}
                                {% for item in object.items.all %}
                                <div class="product-row row mb-3 p-3 border rounded">
                                    <div class="col-md-4">
                                        <label class="form-label">
                                            <i class="bi bi-box-seam"></i> Product <span class="text-danger fw-bold">*</span>
                                        </label>
                                        <select class="form-select product-select" name="products[]">
                                            <option value="">Select Product</option>
                                            {% for product in products %}
                                            <option value="{{ product.id }}" data-unit="{{ product.unit_name }}" data-price="{{ product.cost_price }}" {% if product.id == item.product.id %}selected{% endif %}>
                                                {{ product.name }} ({{ product.unit_name }}) - ৳{{ product.cost_price }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">
                                            <i class="bi bi-building"></i> Warehouse <span class="text-danger fw-bold">*</span>
                                        </label>
                                        <select class="form-select warehouse-select" name="warehouses[]">
                                            <option value="">Select Warehouse</option>
                                            {% for warehouse in warehouses %}
                                            <option value="{{ warehouse.id }}" {% if warehouse.id == item.warehouse.id %}selected{% endif %}>{{ warehouse.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">
                                            <i class="bi bi-hash"></i> Quantity <span class="text-danger fw-bold">*</span>
                                        </label>
                                        <input type="number" class="form-control quantity-input" name="quantities[]" step="0.01" min="0" value="{{ item.quantity }}">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">
                                            <i class="bi bi-currency-dollar"></i> Unit Price <span class="text-danger fw-bold">*</span>
                                        </label>
                                        <input type="number" class="form-control price-input" name="prices[]" step="0.01" min="0" value="{{ item.unit_price }}">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Total</label>
                                        <input type="number" class="form-control total-input" readonly value="{{ item.total_price }}">
                                        <button type="button" class="btn btn-danger btn-sm mt-1 remove-product">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="product-row row mb-3 p-3 border rounded">
                                    <div class="col-md-4">
                                        <label class="form-label">
                                            <i class="bi bi-box-seam"></i> Product <span class="text-danger fw-bold">*</span>
                                        </label>
                                        <select class="form-select product-select" name="products[]">
                                            <option value="">Select Product</option>
                                            {% for product in products %}
                                            <option value="{{ product.id }}" data-unit="{{ product.unit_name }}" data-price="{{ product.cost_price }}">
                                                {{ product.name }} ({{ product.unit_name }}) - ৳{{ product.cost_price }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">
                                            <i class="bi bi-building"></i> Warehouse <span class="text-danger fw-bold">*</span>
                                        </label>
                                        <select class="form-select warehouse-select" name="warehouses[]">
                                            <option value="">Select Warehouse</option>
                                            {% for warehouse in warehouses %}
                                            <option value="{{ warehouse.id }}">{{ warehouse.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">
                                            <i class="bi bi-hash"></i> Quantity <span class="text-danger fw-bold">*</span>
                                        </label>
                                        <input type="number" class="form-control quantity-input" name="quantities[]" step="0.01" min="0">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">
                                            <i class="bi bi-currency-dollar"></i> Unit Price <span class="text-danger fw-bold">*</span>
                                        </label>
                                        <input type="number" class="form-control price-input" name="prices[]" step="0.01" min="0">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Total</label>
                                        <input type="number" class="form-control total-input" readonly>
                                        <button type="button" class="btn btn-danger btn-sm mt-1 remove-product" style="display: none;">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        <button type="button" class="btn btn-outline-primary" id="add-product">
                            <i class="bi bi-plus-circle"></i> Add Product
                        </button>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="id_total_amount" class="form-label">Total Amount</label>
                            <input type="number" class="form-control" id="id_total_amount" name="total_amount" value="{{ object.total_amount|default:0 }}" step="0.01" readonly>
                        </div>
                    </div>
                    
        <div class="mb-3">
            <label for="id_notes" class="form-label">Notes</label>
            <textarea class="form-control" id="id_notes" name="notes" rows="3" placeholder="Enter any additional notes or comments...">{{ object.notes|default:'' }}</textarea>
        </div>
        
        <!-- Help Section -->
        <div class="alert alert-info">
            <h6><i class="bi bi-info-circle"></i> How to Add Products:</h6>
            <ol class="mb-0">
                <li>Select a product from the dropdown</li>
                <li>Choose the warehouse where it will be stored</li>
                <li>Enter the quantity you want to order</li>
                <li>Enter the unit price (cost price)</li>
                <li>Click "Add Product" to add more items</li>
            </ol>
        </div>
        
        <div class="d-flex justify-content-between">
            <a href="{% url 'purchases:order_list' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Orders
            </a>
            <button type="submit" class="btn btn-primary" id="submit-btn">
                <i class="bi bi-check-circle"></i> {% if object %}Update{% else %}Create{% endif %} Order
            </button>
        </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-info-circle"></i>
                    Order Information
                </h6>
            </div>
            <div class="card-body">
                <p class="text-muted small">
                    <strong>Supplier:</strong> Select the supplier for this order.
                </p>
                <p class="text-muted small">
                    <strong>Expected Delivery:</strong> Expected delivery date from supplier.
                </p>
                <p class="text-muted small">
                    <strong>Status:</strong> Track the progress of the order.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('id_order_date').value = today;
            
            // Product selection functionality
            let productRowIndex = 0;
            
            // Add product row
            document.getElementById('add-product').addEventListener('click', function() {
                addProductRow();
            });
            
            // Remove product row
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-product')) {
                    e.target.closest('.product-row').remove();
                    updateTotalAmount();
                    validateForm();
                }
            });
            
            // Product selection change
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('product-select')) {
                    const option = e.target.selectedOptions[0];
                    const row = e.target.closest('.product-row');
                    
                    if (option.dataset.price) {
                        const priceInput = row.querySelector('.price-input');
                        priceInput.value = option.dataset.price;
                        calculateRowTotal(row);
                    }
                    
                    // Show product info
                    if (option.value) {
                        showProductInfo(row, option);
                    } else {
                        hideProductInfo(row);
                    }
                    
                    validateForm();
                }
            });
            
            // Quantity or price change
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('quantity-input') || e.target.classList.contains('price-input')) {
                    const row = e.target.closest('.product-row');
                    calculateRowTotal(row);
                    validateForm();
                }
            });
            
            // Form submission validation
            document.querySelector('form').addEventListener('submit', function(e) {
                if (!validateForm()) {
                    e.preventDefault();
                    showValidationErrors();
                }
            });
            
            // Real-time validation for required fields
            document.addEventListener('input', function(e) {
                if (e.target.hasAttribute('required')) {
                    validateField(e.target);
                }
            });
            
            document.addEventListener('change', function(e) {
                if (e.target.hasAttribute('required')) {
                    validateField(e.target);
                }
            });
            
            function addProductRow() {
                const container = document.getElementById('products-container');
                const firstRow = container.querySelector('.product-row');
                const newRow = firstRow.cloneNode(true);
                
                // Clear values
                newRow.querySelectorAll('select, input').forEach(input => {
                    if (input.type !== 'button') {
                        input.value = '';
                    }
                });
                
                // Show remove button for additional rows
                const removeBtn = newRow.querySelector('.remove-product');
                if (removeBtn) {
                    removeBtn.style.display = 'block';
                }
                
                // Add product info div
                const productInfo = document.createElement('div');
                productInfo.className = 'product-info mt-2';
                productInfo.style.display = 'none';
                newRow.appendChild(productInfo);
                
                container.appendChild(newRow);
                productRowIndex++;
                
                // Focus on the new product select
                newRow.querySelector('.product-select').focus();
            }
            
            function showProductInfo(row, option) {
                let infoDiv = row.querySelector('.product-info');
                if (!infoDiv) {
                    infoDiv = document.createElement('div');
                    infoDiv.className = 'product-info mt-2';
                    row.appendChild(infoDiv);
                }
                
                const unit = option.dataset.unit || 'units';
                const price = option.dataset.price || '0';
                
                infoDiv.innerHTML = `
                    <small class="text-muted">
                        <i class="bi bi-info-circle"></i> 
                        Unit: ${unit} | Suggested Price: ৳${price}
                    </small>
                `;
                infoDiv.style.display = 'block';
            }
            
            function hideProductInfo(row) {
                const infoDiv = row.querySelector('.product-info');
                if (infoDiv) {
                    infoDiv.style.display = 'none';
                }
            }
            
            function calculateRowTotal(row) {
                const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
                const price = parseFloat(row.querySelector('.price-input').value) || 0;
                const total = quantity * price;
                
                row.querySelector('.total-input').value = total.toFixed(2);
                updateTotalAmount();
            }
            
            function updateTotalAmount() {
                let total = 0;
                document.querySelectorAll('.total-input').forEach(input => {
                    total += parseFloat(input.value) || 0;
                });
                
                document.getElementById('id_total_amount').value = total.toFixed(2);
            }
            
            function validateForm() {
                let isValid = true;
                const errors = [];
                
                // Check if at least one product is selected
                const productRows = document.querySelectorAll('.product-row');
                let hasValidProduct = false;
                
                productRows.forEach((row, index) => {
                    const product = row.querySelector('.product-select').value;
                    const warehouse = row.querySelector('.warehouse-select').value;
                    const quantity = row.querySelector('.quantity-input').value;
                    const price = row.querySelector('.price-input').value;
                    
                    if (product && warehouse && quantity && price) {
                        const qty = parseFloat(quantity);
                        const prc = parseFloat(price);
                        
                        if (qty > 0 && prc > 0) {
                            hasValidProduct = true;
                        } else {
                            errors.push(`Product ${index + 1}: Quantity and price must be greater than 0`);
                            isValid = false;
                        }
                    } else if (product || warehouse || quantity || price) {
                        errors.push(`Product ${index + 1}: Please fill all fields (product, warehouse, quantity, price)`);
                        isValid = false;
                    }
                });
                
                if (!hasValidProduct) {
                    errors.push('Please add at least one product to the order');
                    isValid = false;
                }
                
                // Update submit button
                const submitBtn = document.getElementById('submit-btn');
                if (isValid) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Create Order';
                } else {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Fix Errors First';
                }
                
                return isValid;
            }
            
            function showValidationErrors() {
                // This will be handled by Django's form validation
                console.log('Form validation failed');
            }
            
            function validateField(field) {
                const isValid = field.value.trim() !== '';
                
                if (isValid) {
                    field.classList.remove('is-invalid');
                    field.classList.add('is-valid');
                } else {
                    field.classList.remove('is-valid');
                    field.classList.add('is-invalid');
                }
                
                return isValid;
            }

            // Initialize existing products if editing
            if (document.querySelectorAll('.product-row').length > 0) {
                document.querySelectorAll('.product-row').forEach(row => {
                    calculateRowTotal(row);
                });
                updateTotalAmount();
            }
            
            // Initial validation
            validateForm();
        });
</script>
{% endblock %}
