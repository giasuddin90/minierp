{% extends 'base.html' %}

{% block title %}Inventory Report - Building Materials ERP{% endblock %}

{% block page_title %}Inventory Report{% endblock %}

{% block page_actions %}
<div class="btn-group">
    <a href="{% url 'reports:dashboard' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
    <button class="btn btn-primary" onclick="generateReport()">
        <i class="bi bi-download"></i> Generate Report
    </button>
    <button class="btn btn-outline-info" onclick="window.print()">
        <i class="bi bi-printer"></i> Print
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Inventory Summary -->
<div class="row">
    <div class="col-md-3">
        <div class="card text-center border-primary">
            <div class="card-body">
                <h5 class="text-primary">{{ total_products }}</h5>
                <small class="text-muted">Total Products</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-success">
            <div class="card-body">
                <h5 class="text-success">৳{{ total_stock_value|floatformat:2 }}</h5>
                <small class="text-muted">Total Stock Value</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-warning">
            <div class="card-body">
                <h5 class="text-warning">{{ low_stock_items|length }}</h5>
                <small class="text-muted">Low Stock Items</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-info">
            <div class="card-body">
                <h5 class="text-info">{{ recent_movements|length }}</h5>
                <small class="text-muted">Recent Movements</small>
            </div>
        </div>
    </div>
</div>

<!-- Low Stock Items -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-exclamation-triangle"></i>
                    Low Stock Items
                </h6>
            </div>
            <div class="card-body">
                {% if low_stock_items %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Product</th>
                                <th>Current Stock</th>
                                <th>Stock Value</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in low_stock_items %}
                            <tr>
                                <td>
                                    <strong>{{ item.product.name }}</strong><br>
                                    <small class="text-muted">{{ item.product.sku|default:"No SKU" }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-warning">{{ item.quantity|floatformat:2 }}</span>
                                </td>
                                <td class="text-success">৳{{ item.value|floatformat:2 }}</td>
                                <td>
                                    {% if item.quantity <= 0 %}
                                        <span class="badge bg-danger">Out of Stock</span>
                                    {% elif item.quantity < 5 %}
                                        <span class="badge bg-warning">Critical</span>
                                    {% else %}
                                        <span class="badge bg-info">Low</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{% url 'stock:product_detail' item.product.id %}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i> View
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-check-circle fs-1 text-success"></i>
                    <h5 class="text-success mt-3">All items are well stocked!</h5>
                    <p class="text-muted">No low stock items found.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Top Selling Products -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-trophy"></i>
                    Top Selling Products (Last 30 Days)
                </h6>
            </div>
            <div class="card-body">
                {% if top_selling %}
                <div class="list-group list-group-flush">
                    {% for product in top_selling %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ product.product__name }}</strong><br>
                            <small class="text-muted">Quantity: {{ product.total_sold|floatformat:2 }}</small>
                        </div>
                        <div class="text-end">
                            <span class="text-success">৳{{ product.total_value|floatformat:2 }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-3">
                    <i class="bi bi-trophy fs-1 text-muted"></i>
                    <p class="text-muted">No sales data available</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Recent Stock Movements -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-arrow-left-right"></i>
                    Recent Stock Movements
                </h6>
            </div>
            <div class="card-body">
                {% if recent_movements %}
                <div class="list-group list-group-flush">
                    {% for movement in recent_movements %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ movement.product.name }}</strong><br>
                                <small class="text-muted">{{ movement.warehouse.name|default:"No Warehouse" }}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge 
                                    {% if movement.movement_type == 'inward' %}bg-success
                                    {% else %}bg-danger{% endif %}">
                                    {% if movement.movement_type == 'inward' %}+{% else %}-{% endif %}{{ movement.quantity|floatformat:2 }}
                                </span><br>
                                <small class="text-muted">{{ movement.created_at|date:"M d, H:i" }}</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-3">
                    <i class="bi bi-arrow-left-right fs-1 text-muted"></i>
                    <p class="text-muted">No recent movements</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Inventory Valuation -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-calculator"></i>
                    Inventory Valuation Summary
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center">
                            <h6 class="text-primary">Total Products</h6>
                            <h3 class="text-primary">{{ total_products }}</h3>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <h6 class="text-success">Total Stock Value</h6>
                            <h3 class="text-success">৳{{ total_stock_value|floatformat:2 }}</h3>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <h6 class="text-info">Average Value per Product</h6>
                            <h3 class="text-info">
                                ৳1,333.33
                            </h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stock Status Chart -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-pie-chart"></i>
                    Stock Status Distribution
                </h6>
            </div>
            <div class="card-body">
                <canvas id="stockStatusChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-bar-chart"></i>
                    Top Products by Value
                </h6>
            </div>
            <div class="card-body">
                <canvas id="productValueChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Report Summary -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-file-text"></i>
                    Inventory Report Summary
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Total Products: {{ total_products }}</h6>
                        <h6>Total Stock Value: ৳{{ total_stock_value|floatformat:2 }}</h6>
                        <h6>Low Stock Items: {{ low_stock_items|length }}</h6>
                        <h6>Recent Movements: {{ recent_movements|length }}</h6>
                    </div>
                    <div class="col-md-6">
                        <h6>Average Value per Product: ৳1,333.33</h6>
                        <h6>Stock Status: 
                            {% if low_stock_items|length == 0 %}
                                <span class="text-success">Good</span>
                            {% elif low_stock_items|length < 5 %}
                                <span class="text-warning">Attention Needed</span>
                            {% else %}
                                <span class="text-danger">Critical</span>
                            {% endif %}
                        </h6>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Stock Status Chart
const stockStatusCtx = document.getElementById('stockStatusChart').getContext('2d');
new Chart(stockStatusCtx, {
    type: 'doughnut',
    data: {
        labels: ['Well Stocked', 'Low Stock', 'Out of Stock'],
        datasets: [{
            data: [
                {{ total_products|add:0 }},
                {{ low_stock_items|length }},
                0
            ],
            backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Product Value Chart
const productValueCtx = document.getElementById('productValueChart').getContext('2d');
new Chart(productValueCtx, {
    type: 'bar',
    data: {
        labels: [
            {% for product in top_selling|slice:":5" %}
                '{{ product.product__name|truncatechars:15 }}',
            {% endfor %}
        ],
        datasets: [{
            label: 'Value (৳)',
            data: [
                {% for product in top_selling|slice:":5" %}
                    {{ product.total_value }},
                {% endfor %}
            ],
            backgroundColor: '#007bff',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Generate Report Function
function generateReport() {
    fetch(`{% url 'reports:generate_report' 'inventory' %}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Report generated successfully!');
                // You can add logic to download the report here
            } else {
                alert('Error generating report: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error generating report');
        });
}
</script>
{% endblock %}
