{% extends 'base.html' %}

{% block title %}Financial Report - Building Materials ERP{% endblock %}

{% block page_title %}Financial Report{% endblock %}

{% block page_actions %}
<div class="btn-group">
    <a href="{% url 'reports:dashboard' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
    <button class="btn btn-primary" onclick="generateReport()">
        <i class="bi bi-download"></i> Generate Report
    </button>
    <button class="btn btn-outline-info" onclick="window.print()">
        <i class="bi bi-printer"></i> Print
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Date Range Filter -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-calendar"></i>
                    Date Range Filter
                </h6>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-4">
                        <label for="start_date" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="start_date" name="start_date" 
                               value="{{ start_date }}">
                    </div>
                    <div class="col-md-4">
                        <label for="end_date" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="end_date" name="end_date" 
                               value="{{ end_date }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search"></i> Filter
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Financial Summary -->
<div class="row">
    <div class="col-md-3">
        <div class="card text-center border-success">
            <div class="card-body">
                <h5 class="text-success">৳{{ revenue_data.total_revenue|floatformat:2 }}</h5>
                <small class="text-muted">Total Revenue</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-danger">
            <div class="card-body">
                <h5 class="text-danger">৳{{ expense_data.total_expenses|floatformat:2 }}</h5>
                <small class="text-muted">Total Expenses</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-info">
            <div class="card-body">
                <h5 class="{% if profit_loss.gross_profit >= 0 %}text-success{% else %}text-danger{% endif %}">
                    ৳{{ profit_loss.gross_profit|floatformat:2 }}
                </h5>
                <small class="text-muted">Gross Profit</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-warning">
            <div class="card-body">
                <h5 class="text-warning">{{ profit_loss.profit_margin|floatformat:1 }}%</h5>
                <small class="text-muted">Profit Margin</small>
            </div>
        </div>
    </div>
</div>

<!-- Revenue Breakdown -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-arrow-up-circle"></i>
                    Revenue Breakdown
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <h6 class="text-success">Sales Revenue</h6>
                        <h4 class="text-success">৳{{ revenue_data.total_sales|floatformat:2 }}</h4>
                    </div>
                    <div class="col-6">
                        <h6 class="text-info">Other Income</h6>
                        <h4 class="text-info">৳{{ revenue_data.other_income|floatformat:2 }}</h4>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="progress">
                        <div class="progress-bar bg-success" style="width: 70%">
                            Sales: 70%
                        </div>
                        <div class="progress-bar bg-info" style="width: 30%">
                            Other: 30%
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-arrow-down-circle"></i>
                    Expense Breakdown
                </h6>
            </div>
            <div class="card-body">
                {% if expense_data.expenses_by_category %}
                <div class="list-group list-group-flush">
                    {% for category in expense_data.expenses_by_category %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span>{{ category.expense_category__name }}</span>
                        <span class="text-danger">৳{{ category.total|floatformat:2 }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-3">
                    <i class="bi bi-arrow-down-circle fs-1 text-muted"></i>
                    <p class="text-muted">No expenses found for this period</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Cash Flow Analysis -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-cash-coin"></i>
                    Cash Flow Analysis
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h6 class="text-success">Cash Inflows</h6>
                            <h4 class="text-success">৳{{ cash_flow.inflows|floatformat:2 }}</h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h6 class="text-danger">Cash Outflows</h6>
                            <h4 class="text-danger">৳{{ cash_flow.outflows|floatformat:2 }}</h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h6 class="{% if cash_flow.net_cash_flow >= 0 %}text-success{% else %}text-danger{% endif %}">
                                Net Cash Flow
                            </h6>
                            <h4 class="{% if cash_flow.net_cash_flow >= 0 %}text-success{% else %}text-danger{% endif %}">
                                ৳{{ cash_flow.net_cash_flow|floatformat:2 }}
                            </h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h6 class="text-info">Cash Flow Ratio</h6>
                            <h4 class="text-info">
                                {% if cash_flow.outflows > 0 %}
                                    1.2:1
                                {% else %}
                                    N/A
                                {% endif %}
                            </h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Financial Charts -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-pie-chart"></i>
                    Revenue vs Expenses
                </h6>
            </div>
            <div class="card-body">
                <canvas id="revenueExpenseChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-bar-chart"></i>
                    Cash Flow Trend
                </h6>
            </div>
            <div class="card-body">
                <canvas id="cashFlowChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Report Summary -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-file-text"></i>
                    Financial Report Summary
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Period: {{ start_date|date:"M d, Y" }} to {{ end_date|date:"M d, Y" }}</h6>
                        <h6>Total Revenue: ৳{{ revenue_data.total_revenue|floatformat:2 }}</h6>
                        <h6>Total Expenses: ৳{{ expense_data.total_expenses|floatformat:2 }}</h6>
                        <h6>Gross Profit: ৳{{ profit_loss.gross_profit|floatformat:2 }}</h6>
                    </div>
                    <div class="col-md-6">
                        <h6>Profit Margin: {{ profit_loss.profit_margin|floatformat:1 }}%</h6>
                        <h6>Net Cash Flow: ৳{{ cash_flow.net_cash_flow|floatformat:2 }}</h6>
                        <h6>Cash Flow Ratio: 1.2:1</h6>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Revenue vs Expenses Chart
const revenueExpenseCtx = document.getElementById('revenueExpenseChart').getContext('2d');
new Chart(revenueExpenseCtx, {
    type: 'doughnut',
    data: {
        labels: ['Revenue', 'Expenses'],
        datasets: [{
            data: [{{ revenue_data.total_revenue }}, {{ expense_data.total_expenses }}],
            backgroundColor: ['#28a745', '#dc3545'],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Cash Flow Chart
const cashFlowCtx = document.getElementById('cashFlowChart').getContext('2d');
new Chart(cashFlowCtx, {
    type: 'bar',
    data: {
        labels: ['Inflows', 'Outflows', 'Net Flow'],
        datasets: [{
            label: 'Cash Flow (৳)',
            data: [{{ cash_flow.inflows }}, {{ cash_flow.outflows }}, {{ cash_flow.net_cash_flow }}],
            backgroundColor: ['#28a745', '#dc3545', '#28a745'],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Generate Report Function
function generateReport() {
    const startDate = document.getElementById('start_date').value;
    const endDate = document.getElementById('end_date').value;
    
    fetch(`{% url 'reports:generate_report' 'financial' %}?start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Report generated successfully!');
                // You can add logic to download the report here
            } else {
                alert('Error generating report: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error generating report');
        });
}
</script>
{% endblock %}
